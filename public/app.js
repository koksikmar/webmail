(async function(){
function el(tag,props={},...children){const e=document.createElement(tag);for(const k in props){if(k.startsWith('on'))e.addEventListener(k.slice(2),props[k]);else e.setAttribute(k,props[k]);}children.forEach(c=>{if(typeof c==='string')e.appendChild(document.createTextNode(c));else if(c)e.appendChild(c);});return e;}
const root=document.getElementById('root');
async function check(){const r=await fetch('/api/me');return r.json();}
function showLogin(){root.innerHTML='';const username=el('input',{placeholder:'username',id:'username'});const password=el('input',{placeholder:'password',type:'password',id:'password'});const info=el('div');const btnLogin=el('button',{onclick:async()=>{const u=username.value,p=password.value;const res=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});const j=await res.json();if(j.ok) loadApp();else info.textContent=j.error||'Błąd';}},'Zaloguj');const btnReg=el('button',{onclick:async()=>{const u=username.value,p=password.value;const res=await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});const j=await res.json();if(j.ok) loadApp();else info.textContent=j.error||'Błąd';}},'Zarejestruj');root.appendChild(el('div',{},el('div',{},'Login / Rejestracja'),username,password,el('div',{},btnLogin,' ',btnReg),info));}
async function loadApp(){const me=await(await fetch('/api/me')).json();if(!me.logged)return showLogin();root.innerHTML='';const nav=el('nav');const inboxBtn=el('button',{onclick:()=>showInbox()},'Skrzynka odbiorcza');const sentBtn=el('button',{onclick:()=>showSent()},'Wysłane');const composeBtn=el('button',{onclick:()=>showCompose()},'Napisz');const logoutBtn=el('button',{onclick:async()=>{await fetch('/api/logout',{method:'POST'});showLogin();}},'Wyloguj');nav.append(inboxBtn,sentBtn,composeBtn,logoutBtn);root.appendChild(el('div',{},el('div',{},'Zalogowany jako: '+me.user.email),nav,el('div',{id:'view'})));showInbox();}
async function showInbox(){const view=document.getElementById('view');view.innerHTML='Ładuję...';const res=await fetch('/api/messages/inbox');const j=await res.json();if(!j.ok){view.textContent='Błąd';return;}view.innerHTML='';if(j.messages.length===0)view.textContent='Brak wiadomości';j.messages.forEach(m=>{const div=el('div',{class:'msg'},el('strong',{},'From: '+m.from_email),el('div',{},'Temat: '+(m.subject||'')),el('div',{},m.body),el('div',{},new Date(m.created_at).toLocaleString()));view.appendChild(div);});}
async function showSent(){const view=document.getElementById('view');view.innerHTML='Ładuję...';const res=await fetch('/api/messages/sent');const j=await res.json();if(!j.ok){view.textContent='Błąd';return;}view.innerHTML='';if(j.messages.length===0)view.textContent='Brak wiadomości';j.messages.forEach(m=>{const div=el('div',{class:'msg'},el('strong',{},'To: '+m.to_email),el('div',{},'Temat: '+(m.subject||'')),el('div',{},m.body),el('div',{},m.sent?'Wysłano: '+new Date(m.sent_at).toLocaleString():'Nie wysłano'));view.appendChild(div);});}
function showCompose(){const view=document.getElementById('view');view.innerHTML='';const to=el('input',{placeholder:'to (np. jan@zsoiz.pl)'});const subject=el('input',{placeholder:'Temat'});const body=el('textarea',{rows:8,placeholder:'Treść wiadomości'});const info=el('div');const sendBtn=el('button',{onclick:async()=>{const res=await fetch('/api/messages/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to:to.value,subject:subject.value,body:body.value})});const j=await res.json();if(j.ok){info.textContent=j.sent?'Wysłano':'Zapisano lokalnie';showSent();}else{info.textContent=j.error||'Błąd';}}},'Wyślij');view.append(to,subject,body,sendBtn,info);}
const me=await check();if(!me.logged)showLogin();else loadApp();
})();